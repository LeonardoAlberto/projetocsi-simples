{% extends "includes/base.html" %}

{% block content %}
<header>
    <div class="footer_top">
        <div style="display: flex; align-items: center;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" id="toggleButton"
                onclick="toggleWidth()">
                <path fill="white" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
            </svg>
        </div>
        <div style="display: flex; align-items: center;">
            <p style="margin-right: 10px;">{{dados_user[0]['nome']}}</p>
            <img src="data:image/png;base64,{{  dados_user[0]['foto_user']  }}"
                style="border-radius: 50%; width: 38px; height: 38px">
        </div>
    </div>

    <div class="content">
        <div class="tarefas">
            <table>
                <tr>
                    <th>Solicitante</th>
                    <th>Assunto</th>
                    <th>Setor Origem</th>
                    <th>Setor Destinatário</th>
                    <th>Prioridade</th>
                    <th>Descrição</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>

                {% for i in range(len_chamados) %}
                <tr>
                    <td style="text-transform: capitalize;">{{dados[i]['solicitante']}}</td>
                    <td>{{dados[i]['assunto']}}</td>
                    <td style="text-transform: capitalize;">{{dados[i]['setor_origem']}}</td>
                    <td style="text-transform: capitalize;">{{dados[i]['setor_destinatario']}}</td>
                    <td style="text-transform: capitalize;">{{dados[i]['prioridade']}}</td>
                    <td>{{dados[i]['descricao']}}</td>

                    <td style="padding: 0; text-align: center;" class="{{dados[i]['status']}}">
                        <div class="dropdown">
                            <select name="status" id="status-select-{{dados[i]['codigo']}}"
                                style="width: auto; border: none; box-shadow: none; background-color: transparent;"
                                onchange="updateStatus('{{dados[i]['codigo']}}', this.value)">
                                <option style="color: black;" value="aberto" {% if dados[i]['status']=='aberto' %}
                                    selected {% endif %}>Aberto</option>
                                <option style="color: black;" value="em_andamento" {% if
                                    dados[i]['status']=='em_andamento' %} selected {% endif %}>Em Andamento</option>
                                <option style="color: black;" value="resolvido" {% if dados[i]['status']=='resolvido' %}
                                    selected {% endif %}>Resolvido</option>
                                <option style="color: black;" value="pendente" {% if dados[i]['status']=='pendente' %}
                                    selected {% endif %}>Pendente</option>
                            </select>
                        </div>
                    </td>

                    <td style="text-transform: capitalize; text-align: center; align-items: center;">
                        <a href="{{ url_for('static', filename='uploads/' + dados[i]['file_path']) }}" target="_blank"
                            title="Baixar Arquivo">
                            <i class="fas fa-download" style="padding: 5px;"></i>
                        </a>

                        <button data-id="{{ dados[i]['codigo'] }}" class="btn_table chat-icon" style="padding: 5px;"
                            onclick="fechar_chat(this)" title="Chat">
                            <span class="icon"></span>
                        </button>

                        <a href="/resposta_chamado/{{dados[i]['codigo']}}" class="btn_table chat-icon" title="Responder">
                            <i class="fas fa-reply" style="font-size: 16px;"></i>
                        </a>

                    </td>
                </tr>

                <div id="chat_background" style="display: none;" data-id="{{ dados[i]['codigo'] }}">
                    <p style="cursor: pointer; position: fixed; right: 0px; font-size: 26px; margin: 25px; color: white;"
                        onclick="fechar_chat()">&#x2716;</p>
                    <div class="chat_grande">
                        <input type="text" id="mensagemInput" placeholder="Digite sua mensagem"
                            data-id="{{ dados[i]['codigo'] }}" minlength="1">
                    </div>
                </div>

                {%endfor%}
            </table>
        </div>
    </div>
</header>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let chatCodigo;
        $('.btn_table').click(function () {
            chatCodigo = $(this).data("id");
            updateList(chatCodigo);
        });

        setInterval(function () {
            if (chatCodigo) {
                updateList(chatCodigo);
            }
        }, 2000);

        function formatarData(dataString) {
            var dataObjeto = new Date(dataString);
            var dia = ("0" + dataObjeto.getDate()).slice(-2);
            var mes = ("0" + (dataObjeto.getMonth() + 1)).slice(-2);
            var hora = ("0" + dataObjeto.getHours()).slice(-2);
            var minutos = ("0" + dataObjeto.getMinutes()).slice(-2);
            return dia + '/' + mes + ' ' + hora + ':' + minutos;
        }

        function updateList(codigo) {
            $.ajax({
                url: '/mensagens',
                type: 'GET',
                data: { codigo: codigo },
                success: function (data) {
                    var $chatGrande = $('#chat_background .chat_grande');
                    $chatGrande.children().not('#mensagemInput').remove();
                    data.forEach(function (item) {

                        if (item[1] === '{{dados_user[0]["nome"]}}') {
                            var classeEstilo = "message-enviada"
                        } else {
                            var classeEstilo = "message-recebida"
                        }

                        var dataFormatada = formatarData(item[3]);

                        $chatGrande.append('<span class="P ' + classeEstilo + '"><strong>' + item[1] + '</strong><div class="msg_flex"> <p style="margin-right:10px;">' + item[2] + '</p> <span style="white-space: nowrap;">' + dataFormatada + '</span></div></span>');
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao atualizar lista de mensagens:', error);
                }
            });
        }


        function enviarMensagem() {
            var mensagem = $('#mensagemInput').val();
            var codigo = chatCodigo
            $.ajax({
                url: '/enviar_mensagem',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ mensagem: mensagem, codigo: codigo }),
                success: function (response) {
                    console.log('Mensagem enviada com sucesso:', response);
                    $('#mensagemInput').val('');
                    updateList(codigo);
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao enviar mensagem:', error);
                }
            });
        }

        $('#mensagemInput').keypress(function (e) {
            if (e.which == 13) {
                enviarMensagem();
            }
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateStatus(codigo, status) {
        $.ajax({
            type: "POST",
            url: "/alterar_status_chamado/" + codigo,
            data: { status: status },
            success: function (response) {
                console.log("Status atualizado com sucesso:", response);
                $("#status-select-" + codigo).closest('td').attr('class', status);
            },
            error: function (xhr, status, error) {
                console.error("Erro ao atualizar status:", error);
            }
        });
    }
</script>
{% endblock %}