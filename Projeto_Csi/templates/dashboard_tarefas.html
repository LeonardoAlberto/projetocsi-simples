{% extends "includes/base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<header>
    <div class="footer_top">
        <div style="display: flex; align-items: center;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" id="toggleButton"
                onclick="toggleWidth()">
                <path fill="white" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
            </svg>
        </div>
        <div style="display: flex; align-items: center;">
            <p style="margin-right: 10px;">{{ dados[0]['nome'] }}</p>
            <img src="data:image/png;base64,{{ dados[0]['foto_user'] }}"
                style="border-radius: 50%; width: 32px; height: 32px;">
        </div>
    </div>

    <div class="content" style="max-width: 90%; display: flex; justify-content: space-around; margin-bottom: 15px;">
        <canvas id="doughnut-chart" style="max-width: 33%; max-height:400px;"></canvas>
        <canvas id="bar-chart" style="max-width: 33%; max-height: 400px;"></canvas>
        <canvas id="line-chart" style="max-width: 33%; max-height: 400px;"></canvas>
    </div>


    <div class="content" id="content_task" style="max-width: 90%;">
        <div class="content_01">
            <h3><strong>As 10 ações mais próximas do vencimento</strong></h3>
            <p>{{len_dados_task}} Ações pendente</p>
        </div><br>

        <div class="tarefas">
            <table>
                <tr>
                    <th>OBJETIVO GERAL:</th>
                    <th>ACOES (O QUE)?:</th>
                    <th>POR QUE?</th>
                    <th>RESPONSAVEL/FACILITADOR?</th>
                    <th>STATUS:</th>
                    <th style="white-space: nowrap;">DATA INICIO:</th>
                    <th style="white-space: nowrap;">PRAZO FINAL:</th>
                    <th>CUSTO:</th>
                </tr>

                {% for i in range(len_dados_task) %}
                <tr>
                    <td>{{dados_task[i]['objetivo']}}</td>
                    <td style="text-transform: capitalize;">{{dados_task[i]['acoes_oque']}}</td>
                    <td>{{dados_task[i]['por_que']}}</td>

                    <td style="padding: 0;">
                        <div style="display: block;">
                            {% for nome in dados_task[i]['responsavel'].split(',') %}
                            <div
                                style="padding: 5px 0px; text-align: center; width: 100%; margin: 3px 0px; border-top: #e7dfdf 1px solid; border-bottom: #e7dfdf 1px solid;">
                                {{ nome.strip() }}
                            </div>
                            {% endfor %}
                        </div>
                    </td>

                    <td style="padding: 0; text-align: center;" class="{{ dados_task[i]['status'] }}">
                        <div class="dropdown">
                            <select name="status" id="status-select-{{ dados_task[i]['id'] }}"
                                style="width: auto; border: none; box-shadow: none; background-color: transparent;"
                                onchange="updateStatus('{{ dados_task[i]['id'] }}', this.value)">
                                <option style="color: black;" value="nao_iniciada" {% if
                                    dados_task[i]['status']=='nao_iniciada' %} selected {% endif %}>Não Iniciada
                                </option>
                                <option style="color: black;" value="em_andamento" {% if
                                    dados_task[i]['status']=='em_andamento' %} selected {% endif %}>Em Andamento
                                </option>
                                <option style="color: black;" value="pausada" {% if dados_task[i]['status']=='pausada'
                                    %} selected {% endif %}>Pausada</option>
                                <option style="color: black;" value="pronta_para_revisao" {% if
                                    dados_task[i]['status']=='pronta_para_revisao' %} selected {% endif %}>
                                    Pronto para Revisão</option>
                                <option style="color: black;" value="concluida" {% if
                                    dados_task[i]['status']=='concluida' %} selected {% endif %}>Concluída
                                </option>
                            </select>
                        </div>
                    </td>


                    <td style="white-space: nowrap;">{{dados_task[i]['data_inicio']|format_date_brl}}</td>
                    <td style="white-space: nowrap;" data-prazo="{{ dados_task[i][8] }}">{{
                        dados_task[i]['prazo_final']|format_date_brl}}</td>
                    <td>{{ dados_task[i]['custo'] | format_brl }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</header>

<script>
    var ctxDoughnut = document.getElementById("doughnut-chart").getContext("2d");
    var statusLabels = {{ status_labels | tojson }};
    var statusData = {{ status_data | tojson }};

    var doughnutChart = new Chart(ctxDoughnut, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                backgroundColor: [
                    "rgba(255, 99, 132, 0.7)",
                    "rgba(54, 162, 235, 0.7)",
                    "rgba(255, 206, 86, 0.7)",
                    "rgba(75, 192, 192, 0.7)",
                    "rgba(153, 102, 255, 0.7)"
                ],
                data: statusData
            }]
        },
        options: {
            responsive: true
        }
    });

    var ctxLine = document.getElementById("line-chart").getContext('2d');
    var dates = {{ dates | tojson }};
    var counts = {{ counts | tojson }};

    var lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Número de Ações Criadas',
                data: counts,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });

    var ctxBar = document.getElementById("bar-chart").getContext("2d");
    var userNames = {{ user_names | tojson }};
    var taskCounts = {{ task_counts | tojson }};
    var completedTasks = {{ completed_tasks | tojson }};

    var barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: userNames,
            datasets: [
                {
                    label: 'Ações Atribuídas',
                    data: taskCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Ações Concluídas',
                    data: completedTasks,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateStatus(codigo, status) {
        $.ajax({
            type: "POST",
            url: "/alterar_status/" + codigo,
            data: { status: status },
            success: function (response) {
                $("#status-select-" + codigo).closest('td').attr('class', status);
            },
            error: function (xhr, status, error) {
                console.error("Error updating status:", error);
            }
        });
    }
</script>
<script src="{{ url_for('static',     filename='js/script.js') }}"></script>

{% endblock %}